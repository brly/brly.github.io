---
layout: post
title: Jisaku
tags: [AMD, Ryzen]
---

<img src="/assets/posts/2017-06-12/top.jpg">

初めてPCを自作した. しかも安定ではなくコストパフォーマンスを取って AMD の Ryzen にした.

総額 20万くらい. 初めてなのでもちろん使いまわせるパーツなどもなく.

- CPU: Ryzen7 1700
  - 付属の CPU クーラーを利用
- GPU: GTX 1080 Ti
- Memory: CMK16GX4M2A2666C16 (8GB x2)
- ケース: H440-PLUS-BBL
- HDD: 3.5 inch 2TB
- マザーボード: PRIME X370 PRO
- 電源: Corsair CX650M

とりあえず計算資源のために買ってみたので, OS は Linux (Ubuntu 17.04) にした.
なんかよくわかってないけど, kernel 4.10 以降がおすすめだという話から.
そもそも LTS じゃないし多分消すだろうし, とりあえず使えればよいという心持ち.

### ハマったところ

物理的な組み立ては, ケース名で検索したりして出てきた blog などを参考にした.

- [http://jisaku-game.com/archives/67](http://jisaku-game.com/archives/67)

この例では Q-Connector などの説明があり, 何の知識もないので助かった.

苦戦したのは電源から伸びる CPU 補助電源ケーブル 8pin が足りなくて, 延長ケーブルが必要になった程度.
ビッグカメラに行って, 8pin の 12V と書いてあるものを適当に買ったら EPS 12v と書いてあり, マザーボードの説明書には
EATX 12v とあり, あれ違うと思ったけど刺してみたら動いた.

#### 画面が付かない

マザーボードの HDMI 出力からディスプレイにつないで BIOS 画面を待っていたけど, 一向に出ない.

調べたところ, どうやらあの出力は 対応した APU (?) がついてないと使えないものらしく, GTX につなぐと BIOS の画面が出力された.

Chrome の検索履歴を見る限りでは, ここで数時間溶かした模様.

#### live usb の boot が失敗する

live usb は手元の Mac Book Pro で Ubuntu 17.04 の iso を落とし, 以下の記事にしたがって作成.

- [http://qiita.com/kpkpkp/items/6664a1dba97198b984ec](http://qiita.com/kpkpkp/items/6664a1dba97198b984ec)

いざ起動させると, なにやら起動しない.

- [https://www.reddit.com/r/Amd/comments/5y1902/1700_asus_prime_b350plus_booting_linux/](https://www.reddit.com/r/Amd/comments/5y1902/1700_asus_prime_b350plus_booting_linux/)

どうやら検索してみると grub2 の画面で e を押して edit モードに入り, kernel の boot パラメータに `acpi=off` にすると boot する, というような上記 forum の書き込みがあった. 実際, それで起動した. あとでそれで苦しめられたんだけども.

#### HDD から boot しない

上の方法で無事 live usb が起動し, gui でインストールを進め, 最後に「インストールメディアを抜いたら enter 押してね」のメッセージの画面が表示されて無事 HDD へのインストールは終わり, に見えたが enter を押しても反応がない.

前にも似た現象（ただし、古い Ubuntu であったが）があり, その際は強制的に終了して再起動したらついたので, 1分くらい待ってから強制的に再起動した.

そして HDD から boot させようとしてみると, grub2 の画面が出ることなく紫一色の画面で止まってしまう.

この時点で考えられることとしては, 先程 live usb を起動させようとした時と同じように boot の引数に同じ `acpi=off` を足す必要があったのではないか, ということだった.

そこで, live usb を再び同じようにして起動させ, その時のインストール先であった `/dev/sda2` をマウントして, grub2 の設定のなにがしかを変えれば行けるはずと考える.

マウントまでは出来たが, grub2 の設定は最後に `sudo update-grub` を叩く必要があった. これはログイン中のファイルシステムの構造に依存してしまう. live usb 上で `sudo update-grub` を叩いても, live usb のファイルシステム上で grub2 の設定が行われるだけになってしまう.

実際, これは `chroot` をマウント先ですることで解決出来た.

ところで `update-grub` は `/etc/default/grub` の設定を読み込み, `/boot/grub/grub.cfg` を出力ファイルとして吐き出すようなのだが, マウントした先 (HDDインストール先) には `/boot/grub/grub.cfg` が生成されていなかった. これはインストールに失敗していた, と考えるのだろうか...

まーよくわからないけど `acpi=off` するように `/etc/default/grub` をいじって, `update-grub` して grub.cfg が生成されていることを確認し, HDD ブートを試みると, ちゃんと起動された.

grub2 の調査・理解は以下のサイトが役に立った.

- [http://www.usupi.org/sysad/202.html](http://www.usupi.org/sysad/202.html)

#### 認識される CPU のコア数が 1

正直, ここまで来てヘトヘトだった. ここまでで 1日での作業であって, 不慣れな作業が続いたこともあった.

apt から GTX のドライバを入れたりして一息ついていたが, top を叩いて 1 を押して cpu の具合を見てみると 1 つしかない. web に上がっている cpuinfo の情報を見る限りでは, どうやらコア数表示されるもののようだ. もちろん, cpuinfo でも `processor :0` しかない.

BIOS の設定をいじくりまわしたが, なにも変わらず. マザーボードかCPU のハズレを引いたんや, という気持ちと「やっぱ安定の Intel にしておけば...」という気持ちに苛まれつつも調査を進めると同じような症状を見る人が見られる.

自分と同じように「 `acpi=off` にしてなんとか起動したが 1 コアしか認識されないんだよ」, という書き込みが幾つかの forum で見られた. 大体の forum はそこで終わってしまっている.

1コアしか認識されないことと, `acpi=off` に関連が見られ, よーするにこれを切れば行けるのではという気持ちになり試してみると, うまくいった. top で 1 を押すと 16 コア分表示される.

`acpi=off` にして起動しなくなるのかと思いきや, どうやらそうではなくなっていたようだ.

あんまり良くわかっていないが, GTX のドライバを当てる前ではそれが必要で, 当てた後は必要なくなっていた.

どうやら `acpi=off` がかなり強力なパラメータらしく, 所望の動作(=ドライバを当てる前にうまく boot させる)としては `nomodeset` で事足りているようだった.

作業した日はこれでヘトヘトになり, 何か重たいワークロードを動かしてみる気にもならなかった.


#### その他

あとは現時点でよく書かれているように usb 周りの動作がやばい. これは原因がどこなのかあんまり良くわかってないが.
usb 機器の動作が不安定なのはもちろん, usb ハブを繋いでると Windows ですらブートに失敗するなど色々見られる.

個人的にはよく使うので, 早く治って欲しい :pray:
